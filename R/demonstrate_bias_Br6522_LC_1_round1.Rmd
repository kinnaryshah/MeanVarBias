---
title: "demonstrate_bias_Br6522_LC_1_round1"
output: html_document
date: '2022-11-27'
---

```{r lc}

library(SpatialExperiment)
library(ggspavis)
library(WeberDivechaLCdata)
library(nnSVG)

#need R 4.2 on jhpce

#download LC data
spe <- WeberDivechaLCdata_Visium()
#subset one sample
spe_Br6522_LC_1_round1 <- spe[, spe$sample_id == "Br6522_LC_1_round1"]

#plotSpots(spe_Br6522_LC_1_round1_annot)

#https://github.com/lmweber/locus-c/blob/main/code/analyses/06_LC_gene_filtering.R
# filter out genes with extremely low expression
# using simple threshold on total UMI counts summed across all spots
n_umis <- 80
ix_low_genes <- rowSums(counts(spe_Br6522_LC_1_round1)) < n_umis
table(ix_low_genes)

spe_Br6522_LC_1_round1 <- spe_Br6522_LC_1_round1[!ix_low_genes, ]
dim(spe_Br6522_LC_1_round1)

# new zeros may have been created after spot-level QC and filtering low-expressed genes
# no zeros in this table
ix_zero_genes <- rowSums(counts(spe)) == 0
table(ix_zero_genes)

# set seed for reproducibility
set.seed(123)
#run nnSVG
spe_Br6522_LC_1_round1 <- nnSVG(spe_Br6522_LC_1_round1)

# show results
rowData(spe_Br6522_LC_1_round1)

# Save an object to a file
saveRDS(spe_Br6522_LC_1_round1, file = "spe_Br6522_LC_1_round1_lowexpr_filter_nnSVG.rds")


```

```{r plotting}

library(SpatialExperiment)
library(here)
library(dplyr)
library(tidyr)
library(readr)
library(ggplot2)
library(ggrepel)
library(viridis)

# Restore the object
res_list <- list(
  humanDLPFC_nnSVG = rowData(readRDS(file = "mean_var_project/spe_Br6522_LC_1_round1_lowexpr_filter_nnSVG.rds")))

# add method names to all columns except gene IDs and gene names
colnames(res_list[["humanDLPFC_nnSVG"]])[-(1:2)] <- paste0(colnames(res_list[["humanDLPFC_nnSVG"]]), "_nnSVG")[-(1:2)]

df_nnSVG <- 
  as.data.frame(res_list$humanDLPFC_nnSVG)

df_effect <- 
  as.data.frame(df_nnSVG) %>% 
  mutate(l_nnSVG = 1 / phi_nnSVG) %>% 
  filter(rank_nnSVG <= 1000)


# variance vs. mean
ggplot(df_effect, 
       aes(x = mean_nnSVG, y = var_nnSVG, color = LR_stat_nnSVG)) + 
  geom_point(size = 0.75) + 
  scale_color_viridis(trans = "log10") + 
  labs(x = "mean logcounts", 
       y = "variance", 
       color = "LR statistic") + 
  ggtitle("nnSVG: human LC") + 
  theme_bw()

# spatial variance vs. mean
ggplot(df_effect, 
       aes(x = mean_nnSVG, y = sigma.sq_nnSVG, color = LR_stat_nnSVG)) + 
  geom_point(size = 0.75) + 
  scale_color_viridis(trans = "log10") + 
  labs(x = "mean logcounts", 
       y = "spatial variance (sigma^2)", 
       color = "LR statistic") + 
  ggtitle("nnSVG: human LC") + 
  theme_bw()

# proportion spatial variance vs. mean
ggplot(df_effect, 
       aes(x = mean_nnSVG, y = prop_sv_nnSVG, color = LR_stat_nnSVG)) + 
  geom_point(size = 0.75) + 
  scale_color_viridis(trans = "log10") + 
  labs(x = "mean logcounts", 
       y = "proportion spatial variance", 
       color = "LR statistic") + 
  ggtitle("nnSVG: human LC") + 
  theme_bw()

```

